---
import "../styles/global.css";
import Sidebar from '@components/Sidebar.astro';
import Sp from '@components/Sp.astro';
import StructuredBreadcrumbs from '@components/Breadcrumbs.astro';
import Footer from '@components/Footer.astro';
import { siteUpdates } from "../data/update";
function getIsUrl(pathname) {
  return Astro.url.pathname === pathname;
}

function getIsUrlStartsWith(pathnameStart) {
  return Astro.url.pathname.startsWith(pathnameStart);
}
const lang = "ja";
const nao  = "ナオ";
const siteName = "NAOMINA121";
const siteUrl = Astro.site?.toString().replace(/\/$/, "") ?? "";
const canonicalURL = new URL(Astro.url.pathname, siteUrl);
const enURL = new URL(Astro.url.pathname, 'https://en.naomina121.com');
const isHome = Astro.url.pathname === '/';
const {frontmatter,update,description,pageTitle,image,pubDate,modDate} = Astro.props;
const descriptionContent = frontmatter? frontmatter.description ? frontmatter.description : frontmatter.pageTitle + "のページです。" : description? description : pageTitle + "のページです。";
const titleTag = isHome ? "NAOMINA121" : frontmatter ? frontmatter.pageTitle + " | NAOMINA121" : pageTitle + " | NAOMINA121";
const mainId = isHome ? "main-body" : "article-body";
const isImage = frontmatter ? frontmatter.image ? true : false : image ? true : false;
const postTitle = frontmatter ? frontmatter.pageTitle  ? frontmatter.pageTitle : pageTitle ? pageTitle : "" : pageTitle ? pageTitle : "";
const ogpImageURL = frontmatter ? frontmatter.image ? new URL(frontmatter.image, siteUrl) : image? image: new URL('/images/nao2.jpg', siteUrl) : image ? new URL(image, siteUrl) : new URL('/images/nao2.jpg', siteUrl);
const ga4TrackingId = 'G-VGYCVR3R5F';
const ga4TrackingCode = `
<script async src="https://www.googletagmanager.com/gtag/js?id=${ga4TrackingId}"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', '${ga4TrackingId}');
</script>
`;
const Person = {
  "@type": "Person",
  "name": "Naomi Hashimoto",
  "alternateName": "naomina121",
  "url": siteUrl + "/profile/about/",
  "sameAs": [
    "https://www.amazon.co.jp/stores/naomina121/author/B0FWB5GP5G/",
    "https://github.com/naomina121",
    "https://qiita.com/naomina121",
    "https://mastodon.naomina121.com/@naomina121",
    "https://www.youtube.com/@naomina121_blog"
  ],
  "jobTitle": "Author"
};

const websiteSchema = {
  "@context": "https://schema.org/",
  "@type": "WebSite",
  "name": siteName,
  "url": siteUrl + "/",
  "description": "ナオの公式サイトです。ブログ、音声ブログ、プロフィール、活動拠点などの情報を発信しています。",
  "inLanguage":"ja-JP",
  "publisher":{
    ...Person
  }
};

const infoSchema = {
  "@context": "https://schema.org/",
  "@type": "WebPage",
  "name": "更新情報一覧",
  "description": "当サイトの更新履歴、新着記事、および運営に関するお知らせの一覧です。",
  "url": `${siteUrl}/updates/`,
  "inLanguage": lang,
  "mainEntity": {
    "@type": "ItemList",
    "itemListOrder": "https://schema.org/ItemListOrderDescending/",
    "numberOfItems": siteUpdates.length,
    "itemListElement": siteUpdates.map((u, i) => ({
      "@type": "ListItem",
      "position": i + 1,
      "item": {
        "@type":"BlogPosting",
        "name": u.title,
        "headline": u.title,
        "description": u.content,
        "articleSection": u.category,
        "about": u.category =="Article" ? [{"@type":"Thing","name":"新着記事"}] : u.category =="Policy" ? [{"@type":"Thing","name":"ポリシー更新"}] : u.category =="Technical" ? [{"@type":"Thing","name":"サイトの更新"}] : [],
        "datePublished": `${u.date}T00:00:00+09:00`,
        "dateModified": u.updatedAt ? `${u.updatedAt}T00:00:00+09:00` : `${u.date}T00:00:00+09:00`,
        "url": `${siteUrl}/updates/${u.slug}/`,
        "image": `${siteUrl}/images/nao2.jpg`,
        "author": {
          "@type": "Person",
          "name": nao,
          "url": `${siteUrl}/profile/about/`
        }
      }
    }))
  }
};

const nobodyPerfectSchema = {
 "@context": "https://schema.org",
 "@type": "VideoObject",
 "name": "完璧な人間なんていない",
 "description": "完璧な人間なんていない\n私たちは機械じゃない。\n完璧な人間なんていない。\n私たちは、生まれる前に、親を選べないように 遺伝子や生育環境を自分たちで選べない。\n私たちは、絶対に障害や病気あるいは老化を防ぐようにように体ができてない。\n完璧な人間になれるなら、 誰もが善良な人間だったはず。\nそして、誰もがそうじゃないことを私たちは知っている。\nだからこそ、 そんな世界だからこそ、 私は、 正しいことより 優しさを忘れずにいる人間でありたい。",
 "url": "https://www.youtube.com/watch?v=JjdGZbvDeC0",
 "embedUrl": "https://www.youtube.com/embed/JjdGZbvDeC0",
 "duration": "PT36S",
 "uploadDate": "2025-04-18T13:35:13Z",
 "thumbnailUrl": [
  "https://i.ytimg.com/vi/JjdGZbvDeC0/maxresdefault.jpg",
  "https://i.ytimg.com/vi/JjdGZbvDeC0/hqdefault.jpg"
 ]
};

const pageSchema = !getIsUrl("/podcast/") && getIsUrlStartsWith("/podcast/") ?
{
    "@context": "https://schema.org/",
    "@type": "PodcastEpisode",
    "name": frontmatter.pageTitle,
    "description": descriptionContent,
    "inLanguage": "ja-JP",
    "image": ogpImageURL.toString(),
    "url": canonicalURL.toString(),
    "datePublished": new Date(frontmatter.pubDate)+"T00:00:00+09:00",
    "dateModified": frontmatter.modDate
    ? new Date(frontmatter.modDate)+"T00:00:00+09:00"
    : new Date(frontmatter.pubDate)+"T00:00:00+09:00",
    "timeRequired": frontmatter.duration,
    "episodeNumber": frontmatter.episodeNumber,
    "partOfSeries": {
      "@type": "PodcastSeries",
      "name": frontmatter.seriesTitle,
      "url":  frontmatter.podcastSeriesUrl,
    },
    "author": {
          "@type": "Person",
          "name": nao,
          "url": `${siteUrl}/profile/about/`
      },
    "publisher": {
      "@type": "Organization",
      "name": "naomina121",
      "url": siteUrl,
      '@id': siteUrl + '/#organization',
      "logo": {
        "@type": "ImageObject",
        "url": siteUrl ? new URL('/images/naomina.jpg', siteUrl).toString() : undefined,
      }
    },
    "associatedMedia": {
      "@type": "VideoObject",
      "name": frontmatter.youtubeTitle,
      "description": frontmatter.youtubeDescription,
      "embedUrl": `https://www.youtube.com/embed/${frontmatter.media.youtubeId}?enablejsapi=1`,
      "url": `https://www.youtube.com/watch?v=${frontmatter.media.youtubeId}`,
      "duration": frontmatter.duration,
      "uploadDate": frontmatter.uploadDate,
      "thumbnailUrl": [
        `https://i.ytimg.com/vi/${frontmatter.media.youtubeId}/maxresdefault.jpg`,
        `https://i.ytimg.com/vi/${frontmatter.media.youtubeId}/sddefault.jpg`,
        `https://i.ytimg.com/vi/${frontmatter.media.youtubeId}/hqdefault.jpg`
      ],
      "hasPart": frontmatter.chapters.map((chapter, index, array) => { // indexとarrayを追加
      const parseTimeToSeconds = (time: string) => {
        const parts = time.split(':').map(Number);
        if (parts.length === 3) {
          return parts[0] * 3600 + parts[1] * 60 + parts[2]; // HH:MM:SS
        }
        if (parts.length === 2) {
          return parts[0] * 60 + parts[1]; // MM:SS
        }
        return 0;
      };
      const parseDurationToSeconds = (duration: string): number => {
        const match = duration.match(/PT(?:(\d+)H)?(?:(\d+)M)?(?:(\d+)S)?/);
        if (!match) return 0;
        const hours = parseInt(match[1] || '0', 10);
        const minutes = parseInt(match[2] || '0', 10);
        const seconds = parseInt(match[3] || '0', 10);
        return hours * 3600 + minutes * 60 + seconds;
      };
      const startSeconds = parseTimeToSeconds(chapter.time);

      let endSeconds: number;

      if (index < array.length - 1) {
      // 最後のチャプターでない場合：次のチャプターの開始時間を終了時間とする
      const nextChapter = array[index + 1];
      endSeconds = parseTimeToSeconds(nextChapter.time);
      } else {
      // 最後のチャプターの場合：動画全体の再生時間を終了時間とする
      endSeconds = parseDurationToSeconds(frontmatter.duration);
      }

      // 安全のため、スタート時間よりは確実に大きい値にする
      endSeconds = Math.max(startSeconds + 1, endSeconds);

      return {
      "@type": "Clip",
      "name": chapter.title,
      "startOffset": startSeconds,
      "endOffset": endSeconds,
      "url": `https://www.youtube.com/watch?v=${frontmatter.media.youtubeId}&t=${startSeconds}s`
      };
    }),
    },
  } : getIsUrl("/updates/") ? infoSchema : getIsUrlStartsWith("/updates/") ? {
    "@context": "https://schema.org/",
    "@type": "WebPage",
    "name": postTitle,
    "description":  update ? update.content : descriptionContent,
    "url": canonicalURL.toString(),
    "inLanguage": lang,
    "isPartOf": {
      "@type": "WebSite",
      "name": siteName,
      "url":siteUrl + "/"
    },
    "license": "https://creativecommons.org/licenses/by-nc-nd/4.0/",
    "usageInfo": "https://naomina121.com/about/cc-by-nc-nd/",
    ...(frontmatter ? { "datePublished": frontmatter.pubDate + "T00:00:00+09:00" } : update ? {"datePublished": `${update.date}T00:00:00+09:00`} : {"datePublished": `${pubDate}T00:00:00+09:00` }),
    ...(frontmatter ? { "dateModified": frontmatter.modDate + "T00:00:00+09:00" } : update ? {"dateModified": update.updatedAt ? `${update.updatedAt}T00:00:00+09:00` : `${update.date}T00:00:00+09:00` } : {"dateModified" : `${modDate}T00:00:00+09:00` }),
}:
!getIsUrl("/info-literacy/") && getIsUrlStartsWith("/info-literacy/") &&
!getIsUrl("/mental-health/") && getIsUrlStartsWith("/mental-health/") &&
!getIsUrl("/blog/") && getIsUrlStartsWith("/blog/") &&
!getIsUrl("/about/") && getIsUrlStartsWith("/about/") && !getIsUrl("/podcast/") && !getIsUrl("/") ? {
    "@context": "https://schema.org",
    "@type": "Article",
    "headline": frontmatter.pageTitle,
    "description": descriptionContent,
    "image": ogpImageURL.toString(),
    "url": canonicalURL.toString(),
    "datePublished": new Date(frontmatter.pubDate)+ "T00:00:00+09:00",
    "dateModified": frontmatter.modDate
    ? new Date(frontmatter.modDate) + "T00:00:00+09:00"
    : new Date(frontmatter.pubDate) + "T00:00:00+09:00"
    ,"author": {
      "@type": "Person",
      "name": frontmatter.author,
    },
    "publisher": {
      "@type": "Organization",
      "name": "naomina121",
      "logo": {
        "@type": "ImageObject",
        "url": siteUrl ? new URL('/images/naomina.jpg', siteUrl).toString() : undefined,
      }
    },
       "license": "https://creativecommons.org/licenses/by-nc-nd/4.0/",
       "usageInfo": "https://naomina121.com/about/cc-by-nc-nd/",
    ...(frontmatter.githubUrl && {"isBasedOn": {
    "@type": "SoftwareSourceCode",
    "name": frontmatter.githubRepoName,
    "codeRepository": "https://github.com/naomina121/naomina121-astro",
    "url": frontmatter.githubUrl,
  }})
}:{
    "@context": "https://schema.org/",
    "@type": "WebPage",
    "name": postTitle,
    "description": descriptionContent,
    "url": canonicalURL.toString(),
    "inLanguage": lang,
    "isPartOf": {
      "@type": "WebSite",
      "name": siteName,
      "url":  siteUrl + "/"
    },
    ...(pubDate && { "datePublished": pubDate + "T00:00:00+09:00" }),
    ...(modDate && { "dateModified": modDate + "T00:00:00+09:00" }),
  };

  const articleSchema = !getIsUrl("/updates/") && getIsUrlStartsWith("/updates/") && {
    "@context": "https://schema.org/",
    "@type": "BlogPosting",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": `${siteUrl}/updates/${update.slug}/`
    },
    "headline": update.title,
    "description": update.content,
    "url": `${siteUrl}/updates/${update.slug}/`,
    "image": {
      "@type": "ImageObject",
      "url": `${siteUrl}/images/nao2.jpg`,
      "width": 1200,
      "height": 630
    },
    "datePublished": `${update.date}T00:00:00+09:00`,
    "dateModified": update.updatedAt ? `${update.updatedAt}T00:00:00+09:00` : `${update.date}T00:00:00+09:00`,
    "inLanguage": lang,
    "author": {
      "@type": "Person",
      "name": nao,
      "url": `${siteUrl}/profile/about/`
    },
    "publisher": {
      "@type": "Organization",
      "name": siteName,
      "logo": {
        "@type": "ImageObject",
        "url": `${siteUrl}/images/naomina.jpg`,
        "width": 600,
        "height": 60
      }
    }
  };

const breadcrumbItems = isHome
  ? [{ name: 'ホーム', item: siteUrl + '/' }]
  : getIsUrl("/updates/")
  ? [
      { name: 'ホーム', item: siteUrl + '/' },
      { name: 'お知らせ一覧', item: siteUrl + '/updates/' },
  ]
  : getIsUrlStartsWith("/updates/")
  ? [
      { name: 'ホーム', item: siteUrl + '/' },
      { name: 'お知らせ一覧', item: siteUrl + '/updates/' },
      { name: postTitle, item: canonicalURL.toString() }
    ]
:getIsUrl("/about/")?[
      { name: 'ホーム', item: siteUrl + '/' },
      { name: '当サイトについて', item: siteUrl + '/about/' }
]
  :getIsUrlStartsWith("/about/")?[
      { name: 'ホーム', item: siteUrl + '/' },
      { name: '当サイトについて', item: siteUrl + '/about/' },
      { name: postTitle, item: canonicalURL.toString() }
]
:getIsUrl("/info-literacy/")?[
      { name: 'ホーム', item: siteUrl + '/' },
      { name: '情報リテラシー', item: siteUrl + '/info-literacy/' }
]
  :getIsUrl("/mental-health/")?[
      { name: 'ホーム', item: siteUrl + '/' },
      { name: 'メンタルヘルス', item: siteUrl + '/mental-health/' },
]:getIsUrl("/blog/")?[
      { name: 'ホーム', item: siteUrl + '/' },
      { name: 'ブログ', item: siteUrl + '/blog/' }
]:getIsUrl("/podcast/")?[
      { name: 'ホーム', item: siteUrl + '/' },
      { name: '音声ブログ', item: siteUrl + '/podcast/' }
]
:getIsUrl("/tags/")
?[
      { name: 'ホーム', item: siteUrl + '/' },
      { name: 'タグ一覧', item: siteUrl + '/tags/' }
]
  : getIsUrlStartsWith("/tags/")
  ? [
      { name: 'ホーム', item: siteUrl + '/' },
      { name: 'タグ一覧', item: siteUrl + '/tags/' },
      { name: postTitle, item: canonicalURL.toString() }
    ]
    :
getIsUrlStartsWith("/blog/") ? [
      { name: 'ホーム', item: siteUrl + '/' },
      { name: 'ブログ', item: siteUrl + '/blog/' },
        { name: postTitle, item: canonicalURL.toString() }
    ] : getIsUrlStartsWith("/profile/") ? [
      { name: 'ホーム', item: siteUrl + '/' },
      { name: 'プロフィール', item: canonicalURL.toString() },
      { name: postTitle, item: canonicalURL.toString() }
    ] : getIsUrlStartsWith("/mental-health/") ? [
      { name: 'ホーム', item: siteUrl + '/' },
      { name: 'メンタルヘルス', item: siteUrl + '/mental-health/' },
      { name: postTitle, item: canonicalURL.toString() }
    ] : getIsUrlStartsWith("/info-literacy/") ? [
      { name: 'ホーム', item: siteUrl + '/' },
      { name: '情報リテラシー', item: siteUrl + '/info-literacy/' },
      { name: postTitle, item: canonicalURL.toString() }
    ] : getIsUrlStartsWith("/podcast/") ? [
      { name: 'ホーム', item: siteUrl + '/' },
      { name: '音声ブログ', item: siteUrl + '/podcast/' },
      { name: postTitle, item: canonicalURL.toString() }
    ] : getIsUrlStartsWith("/materials/") ? [
      { name: 'ホーム', item: siteUrl + '/' },
      { name: '資料室', item: siteUrl + '/materials/' },
      { name: postTitle, item: canonicalURL.toString() }
    ] : [
      { name: 'ホーム', item: siteUrl + '/' },
      { name: postTitle, item: canonicalURL.toString() }
    ];

---

<!doctype html>
<html lang={lang}>
  <head prefix="og: http://ogp.me/ns#">
<script is:inline src="https://www.google.com/recaptcha/api.js"></script>
  <script is:inline>
  function onSubmit(token) {
    let form = document.getElementById('contactForm');
    if(form.reportValidity()) {
      form.submit();
    }
  }</script>
    <Fragment set:html={ga4TrackingCode} />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <meta name="description" content={descriptionContent} />
    <meta property="og:title" content={titleTag} />
    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalURL.toString()} />
    {isImage &&
    <meta property="og:image" content={ogpImageURL.toString()} />
    }
    {!isImage &&
    <meta property="og:image" content={new URL('/images/nao2.jpg', siteUrl).toString()} />
    }
    <meta property="og:description" content={descriptionContent} />
    <meta property="og:site_name" content="naomina121" />
    <meta property="og:locale" content="ja_JP" />
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:site" content="@naomina121">
    <meta name="twitter:title" content={titleTag}>
    <meta name="twitter:description" content={descriptionContent}>
    {isImage &&
    <meta name="twitter:image" content={ogpImageURL.toString()} />
    }
    {!isImage &&
    <meta name="twitter:image" content={new URL('/images/nao2.jpg', siteUrl).toString()} />
    }
    {getIsUrl("/thanks/") && <meta name="robots" content="noindex,nofollow" />}
    <link rel="sitemap" href="/sitemap-index.xml" />
    <script type="application/ld+json" set:html={JSON.stringify(websiteSchema)} />
    <script type="application/ld+json" set:html={JSON.stringify(pageSchema)} />
    {!getIsUrl("/updates/") && getIsUrlStartsWith("/updates/") && <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />}
    {getIsUrl("/profile/nobody-perfect/") && <script type="application/ld+json" set:html={JSON.stringify(nobodyPerfectSchema)} />}
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="canonical" href={canonicalURL.toString()} />
    <link rel="alternate" hreflang={lang} href={canonicalURL.toString()} />
    {getIsUrl("/podcast/") ? null :
    <link rel="alternate" hreflang="en" href={enURL.toString()} />
    }
    <link rel="alternate" hreflang="x-default" href={canonicalURL.toString()} />
    <meta name="generator" content={Astro.generator} />
    <title>{titleTag}</title>
  </head>
  <body>
    <div class="container flex justify-between items-start align-top mx-auto max-w-[1200px]">
    <Sp />
    <Sidebar />
    <main id={mainId} class="w-full max-w-6xl bg-[#1e1e1e] px-16 pb-[60px] border-l-[1px] border-r-[1px] border-[#3c3c3c]">
    <slot />
    </main>
    </div>
    <StructuredBreadcrumbs items={breadcrumbItems} />
    <Footer />
{!getIsUrlStartsWith("/podcast/") &&
<script is:inline>
const myElement = document.querySelector('#article-body');
const m = getComputedStyle(myElement).height;
const aside =document.querySelector('.sidebar');

aside.style.minHeight = m;
aside.style.height= '100%';
</script>
}
{getIsUrlStartsWith("/materials/") && (<script is:inline>
document.getElementById('consent-check').addEventListener('change', function() {
  document.getElementById('show-content').disabled = !this.checked;
});

document.getElementById('show-content').addEventListener('click', function() {
  document.querySelector('.sensitive-notice').style.display = 'none';
  document.getElementById('sensitive-text').classList.remove('hidden');
});
</script>)}
{!getIsUrl("/podcast/") && getIsUrlStartsWith("/podcast/") && <script is:inline>
// ============================================
// グローバル変数
// ============================================
let player; // YouTubeプレーヤーオブジェクト
let transcriptData = []; // トランスクリプトデータを格納
let currentTranscriptIndex = 0; // 現在のトランスクリプトインデックス
let timeUpdateInterval = null; // 時間更新用のインターバルID

// ============================================
// YOUTUBEAPI
// ============================================
let tag = document.createElement("script");
tag.src = "https://www.youtube.com/iframe_api";
let firstScriptTag = document.getElementsByTagName("script")[0];
firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

// ============================================
// API準備完了時の処理
// ============================================
function onYouTubeIframeAPIReady() {
  // YouTubeの動画IDを取得
  const videoId = document.getElementById("player").getAttribute("data-id");

  if (!videoId) {
    return;
  }
  // frontmatterElが存在するか確認
  const ytVideo = document.getElementById("player");
  if (!ytVideo) {
    return;
  }

  console.log(`Initializing player for video ID: ${videoId}`); // ログ追加

  try {
    player = new YT.Player("player", {
      height: "360",
      width: "640",
      videoId: videoId,
      events: {
        // 'onReady'イベントハンドラを追加
        onReady: onPlayerReady,
        // 状態変更イベントを追加
        onStateChange: onPlayerStateChange,
      },
    });
    console.log("YT.Player object created."); // ログ追加
  } catch (error) {
    console.error("Error creating YT.Player:", error); // エラーハンドリング
  }
}

// ============================================
// プレーヤー準備完了時の処理
// ============================================
function onPlayerReady(event) {
  console.log("Player is ready."); // ログ追加: プレーヤー準備完了を確認
  // プレーヤーが準備できてからクリックイベントを設定
  setupChapterClickEvents();
  // トランスクリプトの初期化
  initializeTranscript();
  // アコーディオンの監視を開始
  observeAccordion();
}

// ============================================
// プレーヤー状態変更時の処理
// ============================================
function onPlayerStateChange(event) {
  if (event.data === YT.PlayerState.PLAYING) {
    // 再生開始時にトランスクリプトの更新を開始
    startTranscriptTracking();
  } else {
    // 再生停止時にトランスクリプトの更新を停止
    stopTranscriptTracking();
  }
}

// ============================================
// トランスクリプト関連
// ============================================

// トランスクリプトデータの初期化
function initializeTranscript() {
  // HTMLからトランスクリプトデータを取得
  const transcriptSource = document.getElementById("transcript-source");

  if (!transcriptSource) {
    console.warn("Transcript source element not found");
    return;
  }

  // 複数の形式に対応
  const transcriptItems = transcriptSource.querySelectorAll(
    ".transcript-segment, [data-timestamp]",
  );

  if (transcriptItems.length > 0) {
    // データ属性形式の場合
    transcriptItems.forEach((item) => {
      const timestamp = item.getAttribute("data-timestamp");
      const text = item.textContent.trim();

      if (timestamp && text) {
        const seconds = timeToSeconds(timestamp);
        transcriptData.push({ time: timestamp, text, seconds });
      }
    });
  } else {
    // プレーンテキスト形式の場合（後方互換性のため）
    const transcriptText = transcriptSource.textContent;
    const regex = /\((\d{2}:\d{2})\)\s*(.*?)(?=\(\d{2}:\d{2}\)|$)/gs;
    let match;

    while ((match = regex.exec(transcriptText)) !== null) {
      const time = match[1];
      const text = match[2].trim();
      const seconds = timeToSeconds(time);
      transcriptData.push({ time, text, seconds });
    }
  }

  console.log("Transcript data initialized:", transcriptData);
}

// トランスクリプトコンテナの作成
function createTranscriptContainer() {
  // 既存のコンテナがあれば削除
  const existingContainer = document.getElementById("transcript-container");
  if (existingContainer) {
    existingContainer.remove();
  }

  // HTMLを作成
  const html = `
    <div id="transcript-container" style="display: none;">
      <div id="transcript-box">
        <div id="transcript-content"></div>
      </div>
    </div>
  `;

  // アコーディオンの後に挿入
  const accordion = document.querySelector(".transcript-accordion");
  if (accordion) {
    accordion.insertAdjacentHTML("afterend", html);
  }

  // トランスクリプトの内容を生成
  const contentDiv = document.getElementById("transcript-content");
  transcriptData.forEach((item, index) => {
    const p = document.createElement("p");
    p.className = "transcript-item";
    p.setAttribute("data-index", index);
    p.setAttribute("data-seconds", item.seconds);
    p.innerHTML = `<span class="transcript-time">${item.time}</span> ${item.text}`;

    // クリックで該当箇所にシーク
    p.addEventListener("click", () => {
      if (player && typeof player.seekTo === "function") {
        player.seekTo(item.seconds, true);
      }
    });

    contentDiv.appendChild(p);
  });
}

// アコーディオンの開閉を監視
function observeAccordion() {
  // アコーディオンのdetails要素を取得
  const detailsElement = document.querySelector(".transcript-accordion");
  if (!detailsElement) {
    console.warn("Accordion element not found");
    return;
  }

  // toggleイベントを使用（より確実）
  detailsElement.addEventListener("toggle", (event) => {
    const isOpen = event.target.open;
    console.log("Accordion toggled:", isOpen);
    handleAccordionToggle(isOpen);
  });

  // 初期状態をチェック
  if (detailsElement.hasAttribute("open")) {
    handleAccordionToggle(true);
  }
}

// アコーディオンの開閉時の処理
function handleAccordionToggle(isOpen) {
  console.log("handleAccordionToggle called with:", isOpen);

  const container = document.getElementById("transcript-container");

  if (isOpen) {
    console.log("Opening accordion...");
    // コンテナがなければ作成
    if (!container) {
      console.log("Creating transcript container...");
      createTranscriptContainer();
      // 作成後、表示を確実にする
      setTimeout(() => {
        const newContainer = document.getElementById("transcript-container");
        if (newContainer) {
          newContainer.style.display = "block";
        }
      }, 100);
    } else {
      console.log("Showing existing container...");
      container.style.display = "block";
    }

    // 現在の再生位置に合わせてスクロール
    if (player && typeof player.getCurrentTime === "function") {
      const currentTime = player.getCurrentTime();
      scrollToCurrentTime(currentTime);
    }

    // 再生中であればトラッキングを開始
    if (player && player.getPlayerState() === YT.PlayerState.PLAYING) {
      startTranscriptTracking();
    }
  } else {
    console.log("Closing accordion...");
    // アコーディオンを閉じたときはコンテナを非表示
    if (container) {
      container.style.display = "none";
    }
    stopTranscriptTracking();
  }
}

// トランスクリプトの追跡を開始
function startTranscriptTracking() {
  // 既存のインターバルがあればクリア
  stopTranscriptTracking();

  // 100ミリ秒ごとに現在時間をチェック
  timeUpdateInterval = setInterval(() => {
    if (player && typeof player.getCurrentTime === "function") {
      const currentTime = player.getCurrentTime();
      updateTranscriptHighlight(currentTime);
    }
  }, 100);
}

// トランスクリプトの追跡を停止
function stopTranscriptTracking() {
  if (timeUpdateInterval) {
    clearInterval(timeUpdateInterval);
    timeUpdateInterval = null;
  }
}

// トランスクリプトのハイライトを更新
function updateTranscriptHighlight(currentTime) {
  // 現在の時間に対応するトランスクリプトアイテムを探す
  let activeIndex = -1;
  for (let i = transcriptData.length - 1; i >= 0; i--) {
    if (currentTime >= transcriptData[i].seconds) {
      activeIndex = i;
      break;
    }
  }

  // アクティブなアイテムが変わった場合のみ更新
  if (activeIndex !== currentTranscriptIndex && activeIndex !== -1) {
    currentTranscriptIndex = activeIndex;
    highlightTranscriptItem(activeIndex);
    scrollToTranscriptItem(activeIndex);
  }
}

// トランスクリプトアイテムをハイライト
function highlightTranscriptItem(index) {
  // すべてのハイライトを削除
  document.querySelectorAll(".transcript-item").forEach((item) => {
    item.classList.remove("active");
  });

  // 指定されたアイテムをハイライト
  const activeItem = document.querySelector(
    `.transcript-item[data-index="${index}"]`,
  );
  if (activeItem) {
    activeItem.classList.add("active");
  }
}

// トランスクリプトアイテムまでスクロール
function scrollToTranscriptItem(index) {
  const activeItem = document.querySelector(
    `.transcript-item[data-index="${index}"]`,
  );
  const container = document.getElementById("transcript-box");

  if (activeItem && container) {
    // スムーズスクロール
    const itemTop = activeItem.offsetTop;
    const containerHeight = container.clientHeight;
    const itemHeight = activeItem.clientHeight;

    // アイテムを中央に配置
    const scrollPosition = itemTop - containerHeight / 2 + itemHeight / 2;

    container.scrollTo({
      top: scrollPosition,
      behavior: "smooth",
    });
  }
}

// 指定時間に対応する位置にスクロール
function scrollToCurrentTime(seconds) {
  for (let i = transcriptData.length - 1; i >= 0; i--) {
    if (seconds >= transcriptData[i].seconds) {
      highlightTranscriptItem(i);
      scrollToTranscriptItem(i);
      currentTranscriptIndex = i;
      break;
    }
  }
}

// // ============================================
// // チャプターリスト関連（既存のコード）
// // ============================================

// // 時間文字列 (HH:MM:SS or MM:SS) を秒に変換する関数
function timeToSeconds(timeString) {
  const parts = timeString.split(":").map(Number);
  let seconds = 0;
  if (parts.length === 3) {
    // HH:MM:SS
    seconds = parts[0] * 3600 + parts[1] * 60 + parts[2];
  } else if (parts.length === 2) {
    // MM:SS
    seconds = parts[0] * 60 + parts[1];
  }
  return seconds;
}

function setupChapterClickEvents() {
  console.log("Setting up chapter click events."); // ログ追加
  const chapterListElement = document.getElementById("chapter-list");

  if (!chapterListElement) {
    console.warn('Element with id "chapter-list" not found.');
    return;
  }

  const chapterItems = chapterListElement.querySelectorAll("li");

  chapterItems.forEach((chapter) => {
    chapter.addEventListener("click", handleChapterClick);
  });
}

// クリックイベントのハンドラ関数
function handleChapterClick(event) {
  const chapter = event.currentTarget; // クリックされたli要素
  const seconds = chapter.getAttribute("data-seconds");

  if (seconds === null) {
    console.warn(
      "Clicked item is missing data-seconds attribute:",
      chapter.textContent,
    );
    return;
  }

  console.log(
    `Chapter clicked: ${chapter.textContent.trim()}, seeking to ${seconds}s`,
  ); // ログ追加

  // playerオブジェクトとseekToメソッドの存在を確認
  if (player && typeof player.seekTo === "function") {
    player.seekTo(seconds, true); // 指定秒数に移動し、再生を開始

    // トランスクリプトも同期
    scrollToCurrentTime(seconds);
  } else {
    console.error(
      "Player is not ready or seekTo function is unavailable when clicking chapter.",
    );
  }
}

// ============================================
// CSS スタイルの追加
// ============================================
const style = document.createElement("style");
style.textContent = `
 #transcript-container {
    margin-top: 20px;
  }

  #transcript-box {
    height: 400px;
    overflow-y: auto;
    border: 1px solid #ddd;
    padding: 20px;
    border-radius: 8px;
    position: relative;
  }

  .transcript-item {
    margin-bottom: 15px;
    padding: 10px;
    border-radius: 4px;
    transition: background-color 0.3s ease;
    line-height: 1.6;
    cursor: pointer;
  }

  .transcript-item:hover {
  }

  .transcript-item.active {;
    font-weight: bold;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
  }

  .transcript-time {
    color: #666;
    font-size: 0.9em;
    margin-right: 10px;
    font-weight: normal;
  }

  .transcript-accordion {
    margin-top: 20px;
  }

  .transcript-accordion summary {
    cursor: pointer;
    padding: 10px;
    border-radius: 4px;
    font-weight: bold;
  }

  .transcript-accordion summary:hover {
    opacity: 0.8;
  }

  /* トランスクリプトソースを非表示にする */
  #transcript-source {
    display: none;
  }
`;
document.head.appendChild(style);
</script>
}

  </body>
</html>

